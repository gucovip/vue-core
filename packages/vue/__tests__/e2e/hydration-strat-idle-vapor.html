<div id="app"><button>0</button></div>

<script type="module">
  import {
    createVaporSSRApp,
    defineVaporAsyncComponent,
    ref,
    onMounted,
    hydrateOnIdle,
    delegateEvents,
    template,
    createComponent,
    child,
    renderEffect,
    setText,
  } from '../../dist/vue.runtime-with-vapor.esm-browser.js'

  delegateEvents('click')

  window.isHydrated = false
  const Comp = {
    setup() {
      const count = ref(0)
      onMounted(() => {
        console.log('hydrated')
        window.isHydrated = true
      })

      const n0 = template('<button> </button>', true)()
      const x0 = child(n0)
      n0.$evtclick = () => count.value++
      renderEffect(() => setText(x0, count.value))
      return n0
    },
  }

  const AsyncComp = defineVaporAsyncComponent({
    loader: () =>
      new Promise(resolve => {
        setTimeout(() => {
          console.log('resolve')
          resolve(Comp)
          requestIdleCallback(() => {
            console.log('busy')
          })
        }, 10)
      }),
    hydrate: hydrateOnIdle(),
  })

  createVaporSSRApp({
    setup() {
      return createComponent(AsyncComp)
    },
  }).mount('#app')
</script>
